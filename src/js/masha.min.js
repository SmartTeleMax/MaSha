(function(){function l(a,b,c){function d(){if(e)return null;var g=b;if(b.childNodes&&b.childNodes.length&&!f)b=b.firstChild;else if(b.nextSibling)b=b.nextSibling,f=!1;else if(b.parentNode)b=b.parentNode,b===a&&(e=!0),f=!0,d();g===c&&(e=!0);return g}var b=b||a.childNodes[0],e=!b,f=!1;return d}function r(a){for(var b=1;b<arguments.length;b++)for(key in arguments[b])a[key]=arguments[b][key];return a}function o(a){return(a||"").replace(/^\s+|\s+$/g,"")}function y(a,b){var c="";document.defaultView&&document.defaultView.getComputedStyle?
c=document.defaultView.getComputedStyle(a,"").getPropertyValue(b):a.currentStyle&&(b=b.replace(/\-(\w)/g,function(a,b){return b.toUpperCase()}),c=a.currentStyle[b]);return c}function p(a,b){for(;a&&!j(b).test(a.className);)a=a.parentNode;return a||null}function s(a,b){for(var c=l(a),d;d=c();)if(d.nodeType==1&&j(b).test(d.className))return d}function t(a){for(var a=l(a),b;b=a();)if(b.nodeType==3)return b}function u(a,b){if(a.getElementsByClassName)return a.getElementsByClassName(b);else{for(var c=
[],d,e=l(a);d=e();)d.nodeType==1&&j(b).test(d.className)&&c.push(d);return c}}function m(a){for(var b=[],c=l(a);a=c();)a.nodeType==3&&b.push(a);return b}function j(a){return RegExp("(^|\\s+)"+a+"(?:$|\\s+)","g")}function w(a,b){if(!j(b).test(a.className))a.className=a.className+" "+b}function v(a,b){var c=j(b);if(c.test(a.className))a.className=o(a.className.replace(c,"$1"))}function x(a,b){for(var c=0,d=b.length;c<d;c++)if(b[c]===a)return c;return-1}function k(a,b,c){a.addEventListener?a.addEventListener(b,
c,!1):a.attachEvent&&a.attachEvent("on"+b,c)}function z(a){if(a.pageX==null){var b=document.documentElement,c=document.body;return{x:a.clientX+(b&&b.scrollLeft||c&&c.scrollLeft||0)-(b.clientLeft||0),y:a.clientY+(b&&b.scrollTop||c&&c.scrollTop||0)-(b.clientTop||0)}}return{x:a.pageX,y:a.pageY}}var n=function(a){this.options=r({},n.default_options,a);r(this,{counter:0,savedSel:[],ranges:{},childs:[],blocks:{}});this.init()};n.default_options={regexp:"[^\\s,;:\u2013.!?<>\u2026\\n\u00a0\\*]+",selectable:"selectable-content",
marker:"txtselect_marker",location:window.location,ignored:null,onMark:null,onUnmark:null,onHashRead:function(){var a=s(this.selectable,"user_selection_true");a&&window.setTimeout(function(){for(var b=0,c=0;a;)b+=a.offsetLeft,c+=a.offsetTop,a=a.offsetParent;window.scrollTo(b,c-150)},1)},is_block:function(a){return a.nodeName=="BR"||x(y(a,"display"),["inline","none"])==-1}};n.prototype={init:function(){this.selectable=typeof this.options.selectable=="string"?document.getElementById(this.options.selectable):
this.options.selectable;var a=typeof this.options.marker=="string"?document.getElementById(this.options.marker):this.options.marker;if(typeof this.options.regexp!="string")throw"regexp is set as string";this.regexp=RegExp(this.options.regexp,"ig");var b=this;this.selectable&&(this.enumerateElements(),k(document,"mouseup",function(c){var d=z(c);window.setTimeout(function(){var c=window.getSelection().toString();if(c!=""&&b.regexp.test(c)&&b.range_is_selectable())a.style.top=d.y-33+"px",a.style.left=
d.x+5+"px",w(a,"show")},1)}),k(a,"click",function(c){c.preventDefault?c.preventDefault():c.returnValue=!1;v(a,"show");b.range_is_selectable()&&(b.addSelection(),b.updateHash(),b.options.onMark&&b.options.onMark.call(b))}),k(document,"click",function(b){(b.target||b.srcElement)!=a&&v(a,"show")}),this.readHash())},delete_selections:function(a){for(var b=[],c=a.length;c--;){var d=a[c],e=u(this.selectable,d),f=s(e[e.length-1],"closewrap");f.parentNode.removeChild(f);this.removeTextSelection(e);b.push(this.ranges[d]);
delete this.ranges[d]}},removeTextSelection:function(a){for(var b=a.length;b--;){for(var c=a[b],d=0;d<c.childNodes.length;d++)c.parentNode.insertBefore(c.childNodes[d],c);c.parentNode.removeChild(c)}},is_internal:function(a){for(;a.parentNode;){if(a==this.selectable)return!0;a=a.parentNode}return!1},_siblingNode:function(a,b,c,d,e){for(e=e||this.regexp;a.parentNode&&this.is_internal(a);){for(;a[b+"Sibling"];){for(a=a[b+"Sibling"];a.nodeType==1&&a.childNodes.length;)a=a[c+"Child"];if(a.nodeType==3&&
a.data.match(e)!=null)return{_container:a,_offset:d*a.data.length}}a=a.parentNode}},prevNode:function(a,b){return this._siblingNode(a,"previous","last",1,b)},nextNode:function(a,b){return this._siblingNode(a,"next","first",0,b)},wordCount:function(a){var b=0;if(a.nodeType==3)(a=a.nodeValue.match(this.regexp))&&(b+=a.length);else if(a.childNodes&&a.childNodes.length){a=m(a);for(i=a.length;i--;)b+=a[i].nodeValue.match(this.regexp).length}return b},words:function(a,b,c){a.nodeType==1&&(a=t(a));b=a.data.substring(0,
b).match(this.regexp);if(b!=null){if(c=="start"&&(b=b.length+1),c=="end")b=b.length}else b=1;for(var c=a,a=this.getNum(a),d=this.getFirstTextNode(a);c&&c!=d;){var c=this.prevNode(c,/.*/)._container,e=this.wordCount(c);b+=e}return a+":"+b},symbols:function(a){var b=0;if(a.nodeType==3)b=a.nodeValue.length;else if(a.childNodes&&a.childNodes.length)for(var a=m(a),c=a.length;c--;)b+=a[c].nodeValue.length;return b},updateHash:function(){var a=[];for(key in this.ranges)a.push(this.ranges[key]);this.options.location.hash=
"sel="+a.join(";")},readHash:function(){var a=this.splittedHash();if(a){for(var b=0;b<a.length;b++)this.deserializeSelection(a[b]);this.updateHash();this.options.onHashRead&&this.options.onHashRead.call(this)}},splittedHash:function(){var a=this.options.location.hash;if(a&&(a=a.replace(/^#/,"").replace(/;+$/,""),/^sel\=(?:\d+\:\d+\,\d+\:\d+;)*\d+\:\d+\,\d+\:\d+$/.test(a)))return a=a.substring(4,a.length),a.split(";")},deserializeSelection:function(a){var b=window.getSelection();b.rangeCount>0&&b.removeAllRanges();
(range=this.deserializeRange(a))&&this.addSelection(range)},deserializeRange:function(a){var b=/^([^,]+),([^,]+)$/.exec(a),c=b[1].split(":"),b=b[2].split(":");if(parseInt(c[0],10)<parseInt(b[0],10)||c[0]==b[0]&&parseInt(c[1],10)<=parseInt(b[1],10))if(c=this.deserializePosition(c,"start"),b=this.deserializePosition(b,"end"),c.node&&b.node)return a=document.createRange(),a.setStart(c.node,c.offset),a.setEnd(b.node,b.offset),a;window.console&&typeof console.warn=="function"&&console.warn("Cannot deserialize range: "+
a)},deserializePosition:function(a,b){for(var c=this.blocks[parseInt(a[0],10)],d,e=0;c;){for(var f=RegExp(this.options.regexp,"ig");(myArray=f.exec(c.data))!=null;)if(e++,e==a[1]){if(b=="start")d=myArray.index;if(b=="end")d=f.lastIndex;return{node:c,offset:parseInt(d,10)}}(c=(c=this.nextNode(c,/.*/))?c._container:null)&&this.isFirstTextNode(c)&&(c=null)}return{node:null,offset:0}},serializeRange:function(a){var b=this.words(a.startContainer,a.startOffset,"start"),a=this.words(a.endContainer,a.endOffset,
"end");return b+","+a},checkSelection:function(a){this.checkPosition(a,a.startOffset,a.startContainer,"start");this.checkPosition(a,a.endOffset,a.endContainer,"end");this.checkBrackets(a);this.checkSentence(a);return a},checkPosition:function(a,b,c,d){function e(a){return a.match(j.regexp)!=null}function f(a){return a.match(j.regexp)==null}function g(a,b,c){for(;b>0&&c(a.data.charAt(b-1));)b--;return b}function h(a,b,c){for(;b<a.data.length&&c(a.data.charAt(b));)b++;return b}var j=this;if(c.nodeType==
1&&b>0)b<c.childNodes.length?(c=c.childNodes[b],b=0):(container_txtnodes=m(c),c=container_txtnodes[container_txtnodes.length-1],b=c.data.length);if(d=="start"){if(c.nodeType==1&&o(c.textContent||c.innerText)!="")c=t(c),b=0;if(c.nodeType!=3||c.data.substring(b).match(this.regexp)==null)b=this.nextNode(c),c=b._container,b=b._offset;b=h(c,b,f);b=g(c,b,e);a.setStart(c,b)}if(d=="end"){if(c.nodeType==1&&o(c.textContent||c.innerText)!=""&&b!=0)c=c.childNodes[a.endOffset-1],container_txtnodes=m(c),c=container_txtnodes[container_txtnodes.length-
1],b=c.data.length;if(c.nodeType!=3||c.data.substring(0,b).match(this.regexp)==null)b=this.prevNode(c),c=b._container,b=b._offset;b=g(c,b,f);b=h(c,b,e);a.setEnd(c,b)}},checkBrackets:function(a){this._checkBrackets(a,"(",")",/\(|\)/g,/\(x*\)/g);this._checkBrackets(a,"\u00ab","\u00bb",/\\u00ab|\\u00bb/g,/\u00abx*\u00bb/g)},_checkBrackets:function(a,b,c,d,e){var f=a.toString();if(d=f.match(d)){for(var d=d.join(""),g=d.length+1;d.length<g;)g=d.length,d=d.replace(e,"x");d.charAt(d.length-1)==c&&f.charAt(f.length-
1)==c&&(a.endOffset==1?(c=this.prevNode(a.endContainer),a.setEnd(c.container,c.offset)):a.setEnd(a.endContainer,a.endOffset-1));d.charAt(0)==b&&f.charAt(0)==b&&(a.startOffset==a.startContainer.data.length?(c=this.nextNode(a.endContainer),a.setStart(c.container,c.offset)):a.setStart(a.startContainer,a.startOffset+1))}},checkSentence:function(a){function b(){a.setEnd(c._container,c._offset+1)}if(a.endOffset==a.endContainer.data.length){var c=this.nextNode(a.endContainer,/.*/);if(!c)return;var d=c._container.data.charAt(0)}else c=
{_container:a.endContainer,_offset:a.endOffset},d=a.endContainer.data.charAt(a.endOffset);if(d.match(/\.|\?|\!/)){d=a.toString();if(d.match(/(\.|\?|\!)\s+[A-Z\u0410-\u042f\u0401]/))return b();if(a.startOffset==0&&a.startContainer.previousSibling&&a.startContainer.previousSibling.nodeType==1&&a.startContainer.previousSibling.className=="selection_index")return b();for(var e,f=a.getElementIterator();e=f();)if(e.nodeType==1&&e.className=="selection_index")return b();if(d.charAt(0).match(/[A-Z\u0410-\u042f\u0401]/)){d=
a.startContainer.data.substring(0,a.startOffset);if(!d.match(/\S/))d=this.prevNode(a.startContainer,/\W*/)._container.data;d=o(d);if(d.charAt(d.length-1).match(/(\.|\?|\!)/))return b()}}},mergeSelections:function(a){var b=[],c=a.getElementIterator(),d=c(),e=d,f=p(d,"user_selection_true");f&&(f=/(num\d+)(?:$| )/.exec(f.className)[1],a.setStart(t(s(this.selectable,f)),0),b.push(f));for(;d;)d.nodeType==1&&j("user_selection_true").test(d.className)&&(e=/(num\d+)(?:$|)/.exec(d.className)[0],x(e,b)==-1&&
b.push(e)),e=d,d=c();if(e=p(e,"user_selection_true")){var e=/(num\d+)(?:$| )/.exec(e.className)[1],g;(c=u(this.selectable,e))&&(g=c[c.length-1]);g=m(g);g=g[g.length-1];a.setEnd(g,g.length)}if(b.length)g=a.startContainer,c=a.startOffset,d=a.endContainer,e=a.endOffset,this.delete_selections(b),a.setStart(g,c),a.setEnd(d,e);return a},addSelection:function(a){var a=a||this.getFirstRange(),a=this.checkSelection(a),a=this.mergeSelections(a),b="num"+this.counter;this.ranges[b]=this.serializeRange(a);a.wrapSelection(b+
" user_selection_true");this.addSelectionEvents(b)},addSelectionEvents:function(a){for(var b=!1,c=this,d=u(this.selectable,a),e=d.length;e--;)k(d[e],"mouseover",function(){for(var a=d.length;a--;)w(d[a],"hover");window.clearTimeout(b)}),k(d[e],"mouseout",function(a){for(a=a.relatedTarget;a&&a.parentNode&&a.className!=this.className;)a=a.parentNode;if(!a||a.className!=this.className)b=window.setTimeout(function(){for(var a=d.length;a--;)v(d[a],"hover")},2E3)});e=document.createElement("a");e.className=
"txtsel_close";e.href="#";var f=document.createElement("span");f.className="closewrap";f.appendChild(e);k(e,"click",function(b){b.preventDefault?b.preventDefault():b.returnValue=!1;c.delete_selections([a]);c.updateHash();c.options.onUnmark&&c.options.onUnmark.call(c)});d[d.length-1].appendChild(f);this.counter++;window.getSelection().removeAllRanges()},getFirstRange:function(){var a=window.getSelection();return a.rangeCount?a.getRangeAt(0):null},enumerateElements:function(){function a(d){for(var d=
d.childNodes,e=!1,f=!1,g=0;g<d.length;++g){var h=d.item(g),j=h.nodeType;if(j!=3||h.nodeValue.match(c.regexp))if(j==3){if(!f)b++,e=document.createElement("span"),e.id="selection_index"+b,e.className="selection_index",h.parentNode.insertBefore(e,h),g++,c.blocks[b]=h,e=f=!0}else j==1&&!c.is_ignored(h)&&(c.options.is_block(h)?(h=a(h),e=e||h,f=!1):f||(f=a(h),e=e||f))}return e}var b=0,c=this;a(this.selectable)},isFirstTextNode:function(a){for(var a=[a.previousSibling,a.parentNode.previousSibling],b=a.length;b--;)if(a[b]&&
a[b].nodeType==1&&a[b].className=="selection_index")return!0;return!1},getFirstTextNode:function(a){if(a&&(a=document.getElementById("selection_index"+a)))return a.nextSibling.nodeType==1?a.nextSibling.childNodes[0]:a.nextSibling},getNum:function(a){for(;a.parentNode;){for(;a.previousSibling;){for(a=a.previousSibling;a.nodeType==1&&a.childNodes.length;)a=a.lastChild;if(a.nodeType==1&&a.className=="selection_index")return a.id.replace("selection_index","")}a=a.parentNode}},is_ignored:function(a){return this.options.ignored&&
this.options.ignored(a)},range_is_selectable:function(){var a,b,c,d=!0,e=this.getFirstRange();if(!e)return!1;for(e=e.getElementIterator();a=e();)if(a.nodeType==3&&a.data.match(this.regexp)!=null&&(b=b||a,c=a),a=d&&a.nodeType==3?a.parentNode:a,d=!1,a.nodeType==1){for(;a!=this.selectable&&a.parentNode;){if(this.is_ignored(a))return!1;a=a.parentNode}if(a!=this.selectable)return!1}b=p(b,"user_selection_true");c=p(c,"user_selection_true");return b&&c?(d=/(?:^| )(num\d+)(?:$| )/,d.exec(b.className)[1]!=
d.exec(c.className)[1]):!0}};var q=window.Range||document.createRange().constructor;q.prototype.splitBoundaries=function(){var a=this.startContainer,b=this.startOffset,c=this.endContainer,d=this.endOffset,e=a===c;c.nodeType==3&&d<c.length&&c.splitText(d);a.nodeType==3&&b>0&&(a=a.splitText(b),e&&(d-=b,c=a),b=0);this.setStart(a,b);this.setEnd(c,d)};q.prototype.getTextNodes=function(){for(var a=this.getElementIterator(),b=[],c;c=a();)c.nodeType==3&&b.push(c);return b};q.prototype.getElementIterator=
function(){return l(null,this.startContainer,this.endContainer)};q.prototype.wrapSelection=function(a){this.splitBoundaries();for(var b=this.getTextNodes(),c=b.length;c--;){var d=document.createElement("span");d.className=a;b[c].parentNode.insertBefore(d,b[c]);d.appendChild(b[c])}};window.MaSha=n;if(window.jQuery)jQuery.fn.masha=function(a){a=a||{};a=r({selectable:this[0]},a);return new n(a)}})();

