(function(){function m(a,b,c,d){function e(){if(f)return null;var g=b;b.childNodes&&b.childNodes.length&&!j?b=b[d?"lastChild":"firstChild"]:b[d?"previousSibling":"nextSibling"]?(b=b[d?"previousSibling":"nextSibling"],j=!1):b.parentNode&&(b=b.parentNode,b===a&&(f=!0),j=!0,e());g===c&&(f=!0);return g}var d=!!d,b=b||a[d?"lastChild":"firstChild"],f=!b,j=!1;return e}function s(a){for(var b=1;b<arguments.length;b++)for(key in arguments[b])a[key]=arguments[b][key];return a}function n(a){return(a||"").replace(/^\s+|\s+$/g,
"")}function B(a,b){var c="";document.defaultView&&document.defaultView.getComputedStyle?c=document.defaultView.getComputedStyle(a,"").getPropertyValue(b):a.currentStyle&&(b=b.replace(/\-(\w)/g,function(a,b){return b.toUpperCase()}),c=a.currentStyle[b]);return c}function q(a,b){for(;a&&!l(b).test(a.className);)a=a.parentNode;return a||null}function t(a,b){for(var c=m(a),d=null;d=c();)if(1===d.nodeType&&l(b).test(d.className))return d;return null}function u(a){for(var a=m(a),b=null;(b=a())&&3!==b.nodeType;);
return b}function v(a,b){if(a.getElementsByClassName)return a.getElementsByClassName(b);for(var c=[],d,e=m(a);d=e();)1==d.nodeType&&l(b).test(d.className)&&c.push(d);return c}function o(a){for(var b=[],c=m(a);a=c();)3===a.nodeType&&b.push(a);return b}function l(a){return RegExp("(^|\\s+)"+a+"(?:$|\\s+)","g")}function w(a,b){l(b).test(a.className)||(a.className=a.className+" "+b)}function r(a,b){var c=l(b);c.test(a.className)&&(a.className=n(a.className.replace(c,"$1")))}function z(a,b){for(var c=
0,d=b.length;c<d;c++)if(b[c]===a)return c;return-1}function k(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,c)}function x(a){a.preventDefault?a.preventDefault():a.returnValue=!1}var y=function(){};y.prototype={set_hash:function(a){window.location.hash=a},get_hash:function(){return window.location.hash},add_hashchange:function(a){k(window,"hashchange",a)}};var h=function(a){this.options=s({},h.default_options,a);s(this,{counter:0,savedSel:[],ranges:{},childs:[],
blocks:{}});this.init()};h.version="";h.default_options={regexp:"[^\\s,;:\u2013.!?<>\u2026\\n\u00a0\\*]+",selectable:"selectable-content",marker:"txtselect_marker",ignored:null,select_message:null,location:new y,validate:!1,enable_haschange:!0,onMark:null,onUnmark:null,onHashRead:function(){var a=t(this.selectable,"user_selection_true");a&&!this.hash_was_read&&(this.hash_was_read=!0,window.setTimeout(function(){for(var b=0,c=0;a;)b+=a.offsetLeft,c+=a.offsetTop,a=a.offsetParent;window.scrollTo(b,c-
150)},1))},is_block:function(a){return"BR"==a.nodeName||-1==z(B(a,"display"),["inline","none"])}};h.prototype={init:function(){var a,b;function c(){var c=RegExp(f.options.regexp,"g"),d=window.getSelection().toString();""!=d&&c.test(d)&&f.range_is_selectable()&&(f.marker.style.top=a-33+"px",f.marker.style.left=b+5+"px",w(f.marker,"show"))}function d(c){c=c.touches.item(0);b=c.pageX;a=c.pageY}function e(a){x(a);a.stopPropagation?a.stopPropagation():a.cancelBubble=!0;r(f.marker,"show");f.range_is_selectable()&&
(f.addSelection(),f.updateHash(),f.options.onMark&&f.options.onMark.call(f),f.options.select_message&&f._show_message())}this.selectable="string"==typeof this.options.selectable?document.getElementById(this.options.selectable):this.options.selectable;"string"==typeof this.options.marker?(this.marker=document.getElementById(this.options.marker),null===this.marker&&(this.marker=document.createElement("a"),this.marker.setAttribute("id",this.options.marker),this.marker.setAttribute("href","#"),document.body.appendChild(this.marker))):
this.marker=this.options.marker;if("string"!=typeof this.options.regexp)throw"regexp is set as string";this.regexp=RegExp(this.options.regexp,"ig");var f=this;this.selectable&&(this.is_ignored=this.construct_ignored(this.options.ignored),this.options.select_message&&this.init_message(),this.enumerateElements(),k(this.selectable,"mouseup",function(d){if(d.pageX==null){var e=document.documentElement,f=document.body;b=d.clientX+(e&&e.scrollLeft||f&&f.scrollLeft||0)-(e.clientLeft||0);a=d.clientY+(e&&
e.scrollTop||f&&f.scrollTop||0)-(e.clientTop||0)}else{b=d.pageX;a=d.pageY}window.setTimeout(c,1)}),k(this.selectable,"touchmove",d),k(this.selectable,"touchstart",d),k(this.selectable,"touchend",function(){window.setTimeout(function(){var d=window.getSelection();if(d.rangeCount){d=d.getRangeAt(0).getClientRects();if(d=d[d.length-1]){b=d.left+d.width+document.body.scrollLeft;a=d.top+d.height/2+document.body.scrollTop}}c()},1)}),k(this.marker,"click",e),k(this.marker,"touchend",e),k(document,"click",
function(a){(a.target||a.srcElement)!=f.marker&&r(f.marker,"show")}),this.options.enable_haschange&&this.options.location.add_hashchange(function(){if(f.last_hash!=f.options.location.get_hash()){var a=[],b;for(b in f.ranges)a.push(b);f.delete_selections(a);f.readHash()}}),this.readHash())},delete_selections:function(a){for(var b=[],c=a.length;c--;){var d=a[c],e=v(this.selectable,d),f=t(e[e.length-1],"closewrap");f.parentNode.removeChild(f);this.removeTextSelection(e);b.push(this.ranges[d]);delete this.ranges[d]}},
removeTextSelection:function(a){for(var b=a.length;b--;){for(var c=a[b],d=0;d<c.childNodes.length;d++)c.parentNode.insertBefore(c.childNodes[d],c);c.parentNode.removeChild(c)}},is_internal:function(a){for(;a.parentNode;){if(a==this.selectable)return!0;a=a.parentNode}return!1},_siblingNode:function(a,b,c,d,e){for(e=e||this.regexp;a.parentNode&&this.is_internal(a);){for(;a[b+"Sibling"];){for(a=a[b+"Sibling"];1==a.nodeType&&a.childNodes.length;)a=a[c+"Child"];if(3==a.nodeType&&null!=a.data.match(e))return{_container:a,
_offset:d*a.data.length}}a=a.parentNode}return null},prevNode:function(a,b){return this._siblingNode(a,"previous","last",1,b)},nextNode:function(a,b){return this._siblingNode(a,"next","first",0,b)},wordCount:function(a){var b=0;if(3==a.nodeType)(a=a.nodeValue.match(this.regexp))&&(b+=a.length);else if(a.childNodes&&a.childNodes.length){a=o(a);for(i=a.length;i--;)b+=a[i].nodeValue.match(this.regexp).length}return b},words:function(a,b,c){1==a.nodeType&&(a=u(a));b=a.data.substring(0,b).match(this.regexp);
null!=b?("start"==c&&(b=b.length+1),"end"==c&&(b=b.length)):b=1;for(var c=a,a=this.getNum(a),d=this.getFirstTextNode(a);c&&c!=d;)c=this.prevNode(c,/.*/)._container,b+=this.wordCount(c);return a+":"+b},symbols:function(a){var b=0;if(3==a.nodeType)b=a.nodeValue.length;else if(a.childNodes&&a.childNodes.length)for(var a=o(a),c=a.length;c--;)b+=a[c].nodeValue.length;return b},updateHash:function(){var a=[];for(key in this.ranges)a.push(this.ranges[key]);this.last_hash=a="#sel="+a.join(";");this.options.location.set_hash(a)},
readHash:function(){var a=this.splittedHash();if(a){for(var b=0;b<a.length;b++)this.deserializeSelection(a[b]);this.updateHash();this.options.onHashRead&&this.options.onHashRead.call(this)}},splittedHash:function(){var a=this.options.location.get_hash();if(!a)return null;a=a.replace(/^#/,"").replace(/;+$/,"");if(!/^sel\=(?:\d+\:\d+(?:\:[^:;]*)?\,|%2C\d+\:\d+(?:\:[^:;]*)?;)*\d+\:\d+(?:\:[^:;]*)?\,|%2C\d+\:\d+(?:\:[^:;]*)?$/.test(a))return null;a=a.substring(4,a.length);return a.split(";")},deserializeSelection:function(a){var b=
window.getSelection();0<b.rangeCount&&b.removeAllRanges();(a=this.deserializeRange(a))&&this.addSelection(a)},deserializeRange:function(a){var b=/^([0-9:]+)(?:,|%2C)([0-9:]+)$/.exec(a),c=b[1].split(":"),b=b[2].split(":");if(parseInt(c[0],10)<parseInt(b[0],10)||c[0]==b[0]&&parseInt(c[1],10)<=parseInt(b[1],10)){var d=this.deserializePosition(c,"start"),e=this.deserializePosition(b,"end");if(d.node&&e.node){var f=document.createRange();f.setStart(d.node,d.offset);f.setEnd(e.node,e.offset);if(!this.options.validate||
this.validateRange(f,c[2],b[2]))return f}}window.console&&"function"==typeof window.console.warn&&window.console.warn("Cannot deserialize range: "+a);return null},validateRange:function(a,b,c){var d=!0,e;b&&(e=this.getPositionChecksum(a.getWordIterator(this.regexp)),d=d&&b==e);c&&(e=this.getPositionChecksum(a.getWordIterator(this.regexp,!0)),d=d&&c==e);return d},getRangeChecksum:function(a){sum1=this.getPositionChecksum(a.getWordIterator(this.regexp));sum2=this.getPositionChecksum(a.getWordIterator(this.regexp,
!0));return[sum1,sum2]},getPositionChecksum:function(){return""},deserializePosition:function(a,b){for(var c=this.blocks[parseInt(a[0],10)],d,e=0;c;){for(var f=RegExp(this.options.regexp,"ig");null!=(myArray=f.exec(c.data));)if(e++,e==a[1])return"start"==b&&(d=myArray.index),"end"==b&&(d=f.lastIndex),{node:c,offset:parseInt(d,10)};(c=(c=this.nextNode(c,/.*/))?c._container:null)&&this.isFirstTextNode(c)&&(c=null)}return{node:null,offset:0}},serializeRange:function(a){var b=this.words(a.startContainer,
a.startOffset,"start"),c=this.words(a.endContainer,a.endOffset,"end");this.options.validate&&(a=this.getRangeChecksum(a),b+=":"+a[0],c+=":"+a[1]);return b+","+c},checkSelection:function(a){this.checkPosition(a,a.startOffset,a.startContainer,"start");this.checkPosition(a,a.endOffset,a.endContainer,"end");this.checkBrackets(a);this.checkSentence(a);return a},checkPosition:function(a,b,c,d){function e(a){return null!=a.match(h.regexp)}function f(a){return null==a.match(h.regexp)}function j(a,b,c){for(;0<
b&&c(a.data.charAt(b-1));)b--;return b}function g(a,b,c){for(;b<a.data.length&&c(a.data.charAt(b));)b++;return b}var h=this;1==c.nodeType&&0<b&&(b<c.childNodes.length?(c=c.childNodes[b],b=0):(container_txtnodes=o(c),c=container_txtnodes[container_txtnodes.length-1],b=c.data.length));if("start"==d){if(1==c.nodeType&&""!=n(c.textContent||c.innerText))c=u(c),b=0;if(3!=c.nodeType||null==c.data.substring(b).match(this.regexp))b=this.nextNode(c),c=b._container,b=b._offset;b=g(c,b,f);b=j(c,b,e);a.setStart(c,
b)}if("end"==d){if(1==c.nodeType&&""!=n(c.textContent||c.innerText)&&0!=b)c=c.childNodes[a.endOffset-1],container_txtnodes=o(c),c=container_txtnodes[container_txtnodes.length-1],b=c.data.length;if(3!=c.nodeType||null==c.data.substring(0,b).match(this.regexp))b=this.prevNode(c),c=b._container,b=b._offset;b=j(c,b,f);b=g(c,b,e);a.setEnd(c,b)}},checkBrackets:function(a){this._checkBrackets(a,"(",")",/\(|\)/g,/\(x*\)/g);this._checkBrackets(a,"\u00ab","\u00bb",/\\u00ab|\\u00bb/g,/\u00abx*\u00bb/g)},_checkBrackets:function(a,
b,c,d,e){var f=a.toString();if(d=f.match(d)){for(var d=d.join(""),j=d.length+1;d.length<j;)j=d.length,d=d.replace(e,"x");d.charAt(d.length-1)==c&&f.charAt(f.length-1)==c&&(1==a.endOffset?(c=this.prevNode(a.endContainer),a.setEnd(c.container,c.offset)):a.setEnd(a.endContainer,a.endOffset-1));d.charAt(0)==b&&f.charAt(0)==b&&(a.startOffset==a.startContainer.data.length?(c=this.nextNode(a.endContainer),a.setStart(c.container,c.offset)):a.setStart(a.startContainer,a.startOffset+1))}},checkSentence:function(a){function b(){a.setEnd(c._container,
c._offset+1)}var c,d;if(a.endOffset==a.endContainer.data.length){c=this.nextNode(a.endContainer,/.*/);if(!c)return null;d=c._container.data.charAt(0)}else c={_container:a.endContainer,_offset:a.endOffset},d=a.endContainer.data.charAt(a.endOffset);if(d.match(/\.|\?|\!/)){d=a.toString();if(d.match(/(\.|\?|\!)\s+[A-Z\u0410-\u042f\u0401]/)||0==a.startOffset&&a.startContainer.previousSibling&&1==a.startContainer.previousSibling.nodeType&&"selection_index"==a.startContainer.previousSibling.className)return b();
for(var e,f=a.getElementIterator();e=f();)if(1==e.nodeType&&"selection_index"==e.className)return b();return d.charAt(0).match(/[A-Z\u0410-\u042f\u0401]/)&&(d=a.startContainer.data.substring(0,a.startOffset),d.match(/\S/)||(d=this.prevNode(a.startContainer,/\W*/)._container.data),d=n(d),d.charAt(d.length-1).match(/(\.|\?|\!)/))?b():null}},mergeSelections:function(a){var b=[],c=a.getElementIterator(),d=c(),e=d,f=q(d,"user_selection_true");f&&(f=/(num\d+)(?:$| )/.exec(f.className)[1],a.setStart(u(t(this.selectable,
f)),0),b.push(f));for(;d;)1==d.nodeType&&l("user_selection_true").test(d.className)&&(e=/(num\d+)(?:$|)/.exec(d.className)[0],-1==z(e,b)&&b.push(e)),e=d,d=c();if(e=q(e,"user_selection_true"))e=/(num\d+)(?:$| )/.exec(e.className)[1],c=(c=v(this.selectable,e))?c[c.length-1]:null,c=o(c),c=c[c.length-1],a.setEnd(c,c.length);b.length&&(c=a.startContainer,d=a.startOffset,e=a.endContainer,f=a.endOffset,this.delete_selections(b),a.setStart(c,d),a.setEnd(e,f));return a},addSelection:function(a){var a=a||this.getFirstRange(),
a=this.checkSelection(a),a=this.mergeSelections(a),b="num"+this.counter;this.ranges[b]=this.serializeRange(a);a.wrapSelection(b+" user_selection_true");this.addSelectionEvents(b)},addSelectionEvents:function(a){for(var b=!1,c=this,d=v(this.selectable,a),e=d.length;e--;)k(d[e],"mouseover",function(){for(var a=d.length;a--;)w(d[a],"hover");window.clearTimeout(b)}),k(d[e],"mouseout",function(a){for(a=a.relatedTarget;a&&a.parentNode&&a.className!=this.className;)a=a.parentNode;if(!a||a.className!=this.className)b=
window.setTimeout(function(){for(var a=d.length;a--;)r(d[a],"hover")},2E3)});e=document.createElement("a");e.className="txtsel_close";e.href="#";var f=document.createElement("span");f.className="closewrap";f.appendChild(e);k(e,"click",function(b){x(b);c.delete_selections([a]);c.updateHash();c.options.onUnmark&&c.options.onUnmark.call(c)});d[d.length-1].appendChild(f);this.counter++;window.getSelection().removeAllRanges()},getFirstRange:function(){var a=window.getSelection();return a.rangeCount?a.getRangeAt(0):
null},enumerateElements:function(){function a(b){for(var b=b.childNodes,e=!1,f=!1,j=0;j<b.length;++j){var g=b.item(j),k=g.nodeType;if(3!=k||g.nodeValue.match(c.regexp))3==k?f||(h.captureCount++,e=document.createElement("span"),e.id="selection_index"+h.captureCount,e.className="selection_index",g.parentNode.insertBefore(e,g),j++,c.blocks[h.captureCount]=g,e=f=!0):1==k&&!c.is_ignored(g)&&(c.options.is_block(g)?(g=a(g),e=e||g,f=!1):f||(f=a(g),e=e||f))}return e}var b=this.selectable;h.captureCount=h.captureCount||
0;var c=this;a(b)},isFirstTextNode:function(a){for(var a=[a.previousSibling,a.parentNode.previousSibling],b=a.length;b--;)if(a[b]&&1==a[b].nodeType&&"selection_index"==a[b].className)return!0;return!1},getFirstTextNode:function(a){return!a?null:(a=document.getElementById("selection_index"+a))?1==a.nextSibling.nodeType?a.nextSibling.childNodes[0]:a.nextSibling:null},getNum:function(a){for(;a.parentNode;){for(;a.previousSibling;){for(a=a.previousSibling;1==a.nodeType&&a.childNodes.length;)a=a.lastChild;
if(1==a.nodeType&&"selection_index"==a.className)return a.id.replace("selection_index","")}a=a.parentNode}return null},construct_ignored:function(a){if("function"==typeof a)return a;if("string"==typeof a){for(var b=[],c=[],d=[],a=a.split(","),e=0;e<a.length;e++){var f=n(a[e]);"#"==f.charAt(0)?b.push(f.substr(1)):"."==f.charAt(0)?c.push(f.substr(1)):d.push(f)}return function(a){var e;for(e=b.length;e--;)if(a.id==b[e])return!0;for(e=c.length;e--;)if(l(c[e]).test(a.className))return!0;for(e=d.length;e--;)if(a.tagName==
d[e].toUpperCase())return!0;return!1}}return function(){return!1}},range_is_selectable:function(){var a,b,c,d=!0,e=this.getFirstRange();if(!e)return!1;for(e=e.getElementIterator();a=e();)if(3==a.nodeType&&null!=a.data.match(this.regexp)&&(b=b||a,c=a),a=d&&3==a.nodeType?a.parentNode:a,d=!1,1==a.nodeType){for(;a!=this.selectable&&a.parentNode;){if(this.is_ignored(a))return!1;a=a.parentNode}if(a!=this.selectable)return!1}b=q(b,"user_selection_true");c=q(c,"user_selection_true");return b&&c?(d=/(?:^| )(num\d+)(?:$| )/,
d.exec(b.className)[1]!=d.exec(c.className)[1]):!0},init_message:function(){var a=this;this.msg="string"==typeof this.options.select_message?document.getElementById(this.options.select_message):this.options.select_message;this.close_button=this.get_close_button();this.msg_autoclose=null;k(this.close_button,"click",function(b){x(b);a.hide_message();a.save_message_closed();clearTimeout(a.msg_autoclose)})},get_close_button:function(){return this.msg.getElementsByTagName("a")[0]},get_message_closed:function(){return window.localStorage?
!!localStorage.masha_warning:!!document.cookie.match(/(?:^|;)\s*masha-warning=/)},save_message_closed:function(){window.localStorage?localStorage.masha_warning="true":this.get_closed()||(document.cookie+="; masha-warning=true")},_show_message:function(){var a=this;this.get_message_closed()||(this.show_message(),clearTimeout(this.msg_autoclose),this.msg_autoclose=setTimeout(function(){a.hide_message()},1E4))},show_message:function(){w(this.msg,"show")},hide_message:function(){r(this.msg,"show")}};
var p=window.Range||document.createRange().constructor;p.prototype.splitBoundaries=function(){var a=this.startContainer,b=this.startOffset,c=this.endContainer,d=this.endOffset,e=a===c;3==c.nodeType&&d<c.length&&c.splitText(d);3==a.nodeType&&0<b&&(a=a.splitText(b),e&&(d-=b,c=a),b=0);this.setStart(a,b);this.setEnd(c,d)};p.prototype.getTextNodes=function(){for(var a=this.getElementIterator(),b=[],c;c=a();)3==c.nodeType&&b.push(c);return b};p.prototype.getElementIterator=function(a){return a?m(null,this.endContainer,
this.startContainer,!0):m(null,this.startContainer,this.endContainer)};p.prototype.getWordIterator=function(a,b){var c=this.getElementIterator(b),d,e=0,f=0,j=!1,g,h=this;return function(){if(e==f&&!j){do{do d=c();while(d&&3!=d.nodeType);j=!d;j||(value=d.nodeValue,d==h.endContainer&&(value=value.substr(0,h.endOffset)),d==h.startContainer&&(value=value.substr(h.startOffset)),g=value.match(a))}while(d&&!g);g&&(e=b?0:g.length-1,f=b?g.length-1:0)}else b?f--:f++;return j?null:g[f]}};p.prototype.wrapSelection=
function(a){this.splitBoundaries();for(var b=this.getTextNodes(),c=b.length;c--;){var d=document.createElement("span");d.className=a;b[c].parentNode.insertBefore(d,b[c]);d.appendChild(b[c])}};h.LocationHandler=y;window.MaSha=h;window.jQuery&&(window.jQuery.fn.masha=function(a){a=a||{};a=s({selectable:this[0]},a);return new h(a)});var A=function(a){this.prefix=a};A.prototype={set_hash:function(a){a=a.replace("sel",this.prefix).replace(/^#/,"");a.length==this.prefix.length+1&&(a="");var b=this.get_hash_part();
window.location.hash.replace(/^#\|?/,"");a=b?window.location.hash.replace(b,a):window.location.hash+"|"+a;a="#"+a.replace("||","").replace(/^#?\|?|\|$/g,"");window.location.hash=a},add_hashchange:h.LocationHandler.prototype.add_hashchange,get_hash_part:function(){for(var a=window.location.hash.replace(/^#\|?/,"").split(/\||%7C/),b=0;b<a.length;b++)if(a[b].substr(0,this.prefix.length+1)==this.prefix+"=")return a[b];return""},get_hash:function(){return this.get_hash_part().replace(this.prefix,"sel")}};
window.MultiMaSha=function(a,b){for(var b=b||function(a){return a.id},c=0;c<a.length;c++){var d=a[c],e=b(d);e&&new h({selectable:d,location:new A(e)})}}})();
